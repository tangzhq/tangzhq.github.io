<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.118.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Bluedroid_a2dp"><meta itemprop=description content="保持简单的易用性和强大的功能。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="Hugo,NexT,主题,简单,强大"><meta property="og:type" content="article"><meta property="og:title" content="Bluedroid_a2dp"><meta property="og:description" content="保持简单的易用性和强大的功能。"><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/post/bluetooth/bluedroid_a2dp/"><meta property="og:site_name" content="Hugo NexT"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="NexT 主题"><meta property="article:published_time" content="2023-10-22 13:10:57 +0800 CST"><meta property="article:modified_time" content="2023-10-22 13:10:57 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.7cb02a126b9600d1f6410e19a6702dfada67510ed3c709353c5c1117fb3b8be3.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"bluedroid_a2dp","permalink":"/post/bluetooth/bluedroid_a2dp/","title":"Bluedroid_a2dp","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Bluedroid_a2dp - Hugo NexT</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Hugo NexT</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>为 Hugo 打造的主题</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-flinks"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-thumbs-up hvr-icon"></i>站点示例</a></li><li class="menu-item menu-item-archives"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#bluedroid-a2dp分析>Bluedroid A2DP分析</a></li><li><a href=#源码架构>源码架构</a></li><li><a href=#a2dp初始化过程>A2DP初始化过程</a><ul><li><a href=#创建media-task>创建Media task</a></li><li><a href=#初始化codec>初始化codec</a></li><li><a href=#初始化btif-sm>初始化btif SM</a></li><li><a href=#初始化a2dp服务>初始化a2dp服务</a></li></ul></li><li><a href=#a2dp连接过程>A2DP连接过程</a><ul><li><a href=#codec配置>codec配置</a></li><li><a href=#ccb状态机>ccb状态机</a></li><li><a href=#scb状态机>scb状态机</a></li></ul></li><li><a href=#a2dp音乐播放>A2DP音乐播放</a><ul><li><a href=#bluetooth-audio-hal>Bluetooth Audio HAL</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt="NexT 主题" src=/imgs/img-lazy-loading.gif data-src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>NexT 主题</p><div class=site-description itemprop=description>保持简单的易用性和强大的功能。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>5</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>0</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>0</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/elkan1788 title="Github → https://github.com/elkan1788" rel=noopener target=_blank>Github</a></span>
<span class=links-of-social-item><a href=https://www.zhihu.com/people/lisenhui title="知乎 → https://www.zhihu.com/people/lisenhui" rel=noopener target=_blank>知乎</a></span></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2023-09-23T13:19:26+08:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=4811></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=11></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2024-03-26T08:48:43+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a href=https://github.com/hugo-next rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/post/bluetooth/bluedroid_a2dp/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="NexT 主题"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="NexT 主题"><meta itemprop=description content="保持简单的易用性和强大的功能。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Bluedroid_a2dp"><meta itemprop=description content="Bluedroid A2DP分析 蓝牙A2DP协议定义了两个角色，一个是sink端，如蓝牙耳机，蓝牙音箱，车机等设备。一个是source端，如手机，平板电脑等设"></span><header class=post-header><h1 class=post-title itemprop="name headline">Bluedroid_a2dp
<a href=https://github.compost/bluetooth/bluedroid_a2dp.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text title=发表于>发表于：</span>
<time title="创建时间：2023-10-22 13:10:57 +0800 CST" itemprop="dateCreated datePublished" datetime="2023-10-22 13:10:57 +0800 CST">2023-10-22</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span>
<span>2810</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>6分钟</span></span></div></div></header><div class=post-body itemprop=articleBody><h2 id=bluedroid-a2dp分析>Bluedroid A2DP分析
<a class=header-anchor href=#bluedroid-a2dp%e5%88%86%e6%9e%90></a></h2><p>蓝牙A2DP协议定义了两个角色，一个是sink端，如蓝牙耳机，蓝牙音箱，车机等设备。一个是source端，如手机，平板电脑等设备。在Android中两个角色分别对应两个Profile，sink对应A2dpSink Profile，source对应A2dp Profile。
本文基于Android R版本。</p><h2 id=源码架构>源码架构
<a class=header-anchor href=#%e6%ba%90%e7%a0%81%e6%9e%b6%e6%9e%84></a></h2><div align=center><div class=mxgraph style="max-width:100%;border:1px solid transparent" data-mxgraph='{"highlight":"#0000ff","nav":true,"resize":true,"toolbar":"zoom layers tags lightbox","edit":"_blank","xml":"<mxfile host=\"app.diagrams.net\" modified=\"2023-10-30T05:30:34.697Z\" agent=\"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\" etag=\"ZeicDvPtx4vVg4ewxr7G\" version=\"22.0.8\">\n  <diagram name=\"第 1 页\" id=\"EVlzY6Fr_OQ7-CZGu2Eb\">\n    <mxGraphModel dx=\"1434\" dy=\"796\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"827\" pageHeight=\"1169\" math=\"0\" shadow=\"0\">\n      <root>\n        <mxCell id=\"0\" />\n        <mxCell id=\"1\" parent=\"0\" />\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-1\" value=\"&amp;lt;b&amp;gt;Settings APP&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"340\" y=\"40\" width=\"120\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-3\" value=\"&amp;lt;b&amp;gt;Frameworks&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"240\" y=\"120\" width=\"320\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-6\" value=\"\" style=\"endArrow=classic;startArrow=classic;html=1;rounded=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" source=\"IOKVG7KbzllehCzAGxMQ-3\" target=\"IOKVG7KbzllehCzAGxMQ-1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"300\" y=\"120\" as=\"sourcePoint\" />\n            <mxPoint x=\"300\" y=\"83\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-8\" value=\"\" style=\"endArrow=none;html=1;rounded=1;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"200\" y=\"190\" as=\"sourcePoint\" />\n            <mxPoint x=\"600\" y=\"190\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-9\" value=\"&amp;lt;b&amp;gt;AIDL&amp;lt;/b&amp;gt;\" style=\"text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;labelBackgroundColor=none;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"300\" y=\"170\" width=\"60\" height=\"20\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-10\" value=\"&amp;lt;b&amp;gt;Bluetooth APP Service&amp;lt;br&amp;gt;A2DP Service&amp;lt;br&amp;gt;&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"240\" y=\"220\" width=\"320\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-11\" value=\"\" style=\"endArrow=classic;startArrow=classic;html=1;rounded=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" source=\"IOKVG7KbzllehCzAGxMQ-10\" target=\"IOKVG7KbzllehCzAGxMQ-3\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"440\" y=\"450\" as=\"sourcePoint\" />\n            <mxPoint x=\"490\" y=\"400\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-12\" value=\"&amp;lt;b&amp;gt;Bluetooth A2DP JNI&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"240\" y=\"300\" width=\"320\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-13\" value=\"\" style=\"endArrow=classic;startArrow=classic;html=1;rounded=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" target=\"IOKVG7KbzllehCzAGxMQ-10\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"400\" y=\"300\" as=\"sourcePoint\" />\n            <mxPoint x=\"450\" y=\"420\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-16\" value=\"&amp;lt;b&amp;gt;BTIF_HF&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"340\" y=\"390\" width=\"120\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-17\" value=\"&amp;lt;b&amp;gt;BTA&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"340\" y=\"430\" width=\"120\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-18\" value=\"&amp;lt;b&amp;gt;BT stack&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"340\" y=\"470\" width=\"120\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-19\" value=\"&amp;lt;b&amp;gt;HIDL Interfaces&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"240\" y=\"550\" width=\"320\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-20\" value=\"\" style=\"endArrow=classic;startArrow=classic;html=1;rounded=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" source=\"IOKVG7KbzllehCzAGxMQ-16\" target=\"IOKVG7KbzllehCzAGxMQ-12\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"690\" y=\"400\" as=\"sourcePoint\" />\n            <mxPoint x=\"740\" y=\"350\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"IOKVG7KbzllehCzAGxMQ-21\" value=\"\" style=\"endArrow=classic;startArrow=classic;html=1;rounded=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" source=\"IOKVG7KbzllehCzAGxMQ-19\" target=\"IOKVG7KbzllehCzAGxMQ-18\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"230\" y=\"530\" as=\"sourcePoint\" />\n            <mxPoint x=\"280\" y=\"480\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"DY3fCI7gwXhPoUgZa4Xt-1\" value=\"&amp;lt;b&amp;gt;HIDL&amp;lt;/b&amp;gt;\" style=\"text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;labelBackgroundColor=none;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"409\" y=\"516\" width=\"43\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"DY3fCI7gwXhPoUgZa4Xt-2\" value=\"&amp;lt;b&amp;gt;Kernel&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"240\" y=\"630\" width=\"320\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"DY3fCI7gwXhPoUgZa4Xt-3\" value=\"\" style=\"endArrow=classic;startArrow=classic;html=1;rounded=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" source=\"DY3fCI7gwXhPoUgZa4Xt-2\" target=\"IOKVG7KbzllehCzAGxMQ-19\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"700\" y=\"570\" as=\"sourcePoint\" />\n            <mxPoint x=\"750\" y=\"520\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"7faEcU2vB4YaatOzyJpu-1\" value=\"&amp;lt;b&amp;gt;Audio模块&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"160\" y=\"390\" width=\"80\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"7faEcU2vB4YaatOzyJpu-2\" value=\"\" style=\"shape=flexArrow;endArrow=classic;startArrow=classic;html=1;rounded=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;width=8;startSize=4.67;fillColor=#FAE5C7;\" parent=\"1\" source=\"7faEcU2vB4YaatOzyJpu-1\" target=\"IOKVG7KbzllehCzAGxMQ-16\" edge=\"1\">\n          <mxGeometry width=\"100\" height=\"100\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"120\" y=\"600\" as=\"sourcePoint\" />\n            <mxPoint x=\"220\" y=\"500\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"7faEcU2vB4YaatOzyJpu-3\" value=\"&amp;lt;b&amp;gt;BT Audio HAL&amp;lt;/b&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;rounded=1;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"240\" y=\"370\" width=\"100\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"7faEcU2vB4YaatOzyJpu-4\" value=\"&amp;lt;b&amp;gt;HIDL&amp;lt;/b&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;rounded=1;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"265\" y=\"418\" width=\"50\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n      </root>\n    </mxGraphModel>\n  </diagram>\n</mxfile>\n"}'></div><script type=text/javascript src=https://viewer.diagrams.net/js/viewer-static.min.js></script></div>应用层通过framework层接口使用bluetooth a2dp功能，接口实现位于Bluetooth APP Service（即com.android.bluetooth进程），framework通过AIDL和Bluetooth APP Service通信。Bluetooth APP Service通过JNI和stack层交互。Audio模块通过HIDL将音频PCM数据发送到蓝牙协议栈。<h2 id=a2dp初始化过程>A2DP初始化过程
<a class=header-anchor href=#a2dp%e5%88%9d%e5%a7%8b%e5%8c%96%e8%bf%87%e7%a8%8b></a></h2><div align=center><div class=mxgraph style="max-width:100%;border:1px solid transparent" data-mxgraph='{"highlight":"#0000ff","nav":true,"resize":true,"toolbar":"zoom layers tags lightbox","edit":"_blank","xml":"<mxfile host=\"app.diagrams.net\" modified=\"2023-10-30T05:15:06.315Z\" agent=\"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\" etag=\"5aVe1l7fvKMkEpH10-6T\" version=\"22.0.8\">\n  <diagram name=\"第 1 页\" id=\"P-Dsk4ujABo6LbQ4KsAQ\">\n    <mxGraphModel dx=\"989\" dy=\"549\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"827\" pageHeight=\"1169\" math=\"0\" shadow=\"0\">\n      <root>\n        <mxCell id=\"0\" />\n        <mxCell id=\"1\" parent=\"0\" />\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-2\" value=\"&amp;lt;b&amp;gt;A2DP JNI&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"326\" y=\"80\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-3\" value=\"&amp;lt;b&amp;gt;btif_av&amp;lt;br&amp;gt;&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"517\" y=\"80\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-4\" value=\"&amp;lt;b&amp;gt;bta_av_api&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"678\" y=\"80\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-5\" value=\"&amp;lt;b&amp;gt;A2dpService&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;&amp;quot; color=&amp;quot;#cc00cc&amp;quot;&amp;gt;bt service app层&amp;lt;/font&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"170\" y=\"80\" width=\"120\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-6\" value=\"&amp;lt;b&amp;gt;BluetoothA2dp&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;&amp;quot; color=&amp;quot;#ff0000&amp;quot;&amp;gt;framework层&amp;lt;/font&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"30\" y=\"80\" width=\"110\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-7\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"85\" y=\"480\" as=\"sourcePoint\" />\n            <mxPoint x=\"85\" y=\"120\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-8\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"226\" y=\"480\" as=\"sourcePoint\" />\n            <mxPoint x=\"226\" y=\"120\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-9\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"377\" y=\"480\" as=\"sourcePoint\" />\n            <mxPoint x=\"377\" y=\"120\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-10\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"565\" y=\"480\" as=\"sourcePoint\" />\n            <mxPoint x=\"565\" y=\"120\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-11\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"728\" y=\"480\" as=\"sourcePoint\" />\n            <mxPoint x=\"728\" y=\"120\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-13\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"221\" y=\"150\" width=\"10\" height=\"44\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-14\" value=\"1 : dobind()\" style=\"html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;endSize=6;startSize=6;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0021\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"85\" y=\"152\" as=\"sourcePoint\" />\n            <mxPoint x=\"220\" y=\"152\" as=\"targetPoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"87\" y=\"152\" />\n            </Array>\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-16\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"372\" y=\"180\" width=\"10\" height=\"25\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-17\" value=\"3 : initNative\" style=\"html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"236\" y=\"185\" as=\"sourcePoint\" />\n            <mxPoint x=\"371\" y=\"185\" as=\"targetPoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"242\" y=\"185\" />\n            </Array>\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-18\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"561\" y=\"197\" width=\"10\" height=\"216\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-19\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;movable=1;resizable=1;rotatable=1;deletable=1;editable=1;locked=0;connectable=1;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.6933\" y=\"31\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"382\" y=\"201\" as=\"sourcePoint\" />\n            <mxPoint x=\"561\" y=\"201\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-23\" value=\"6 : btif_av_init\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0411\" y=\"8\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"576\" y=\"222.0344827586207\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"607\" y=\"222\" />\n              <mxPoint x=\"607\" y=\"238\" />\n            </Array>\n            <mxPoint as=\"offset\" />\n            <mxPoint x=\"581\" y=\"238\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-24\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"723\" y=\"377\" width=\"10\" height=\"43\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-25\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" target=\"XsUhhpuSdYIwSIzUmmff-24\" edge=\"1\">\n          <mxGeometry x=\"0.4359\" y=\"17\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"606\" y=\"377\" as=\"sourcePoint\" />\n            <mxPoint x=\"685\" y=\"384\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-2\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"226\" y=\"161\" width=\"10\" height=\"29\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-4\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"566\" y=\"209\" width=\"10\" height=\"201\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-3\" value=\"2 : start()\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"231\" y=\"153\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"231\" y=\"153\" />\n              <mxPoint x=\"261\" y=\"153\" />\n              <mxPoint x=\"261\" y=\"166\" />\n            </Array>\n            <mxPoint x=\"236\" y=\"166\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-5\" value=\"5 : init_src\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"571\" y=\"201\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"571\" y=\"201\" />\n              <mxPoint x=\"601\" y=\"201\" />\n              <mxPoint x=\"601\" y=\"214\" />\n            </Array>\n            <mxPoint x=\"576\" y=\"214\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"XsUhhpuSdYIwSIzUmmff-22\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"571\" y=\"232.5\" width=\"10\" height=\"175\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-6\" value=\"\" style=\"html=1;align=center;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"-1\" y=\"-106\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"582\" y=\"246\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"615\" y=\"246\" />\n              <mxPoint x=\"615\" y=\"262\" />\n            </Array>\n            <mxPoint x=\"-106\" y=\"-103\" as=\"offset\" />\n            <mxPoint x=\"586\" y=\"262.02857142857135\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-8\" value=\"9 :&amp;amp;nbsp;btif_sm_init &amp;lt;br&amp;gt;初始化状态机\" style=\"html=1;align=center;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"-1\" y=\"-96\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"591\" y=\"294.0044827586207\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"622\" y=\"293.97\" />\n              <mxPoint x=\"622\" y=\"309.97\" />\n            </Array>\n            <mxPoint x=\"-96\" y=\"-92\" as=\"offset\" />\n            <mxPoint x=\"596\" y=\"309.97\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-10\" value=\"\" style=\"html=1;align=center;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"-1\" y=\"-126\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"596\" y=\"317.0044827586207\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"627\" y=\"316.97\" />\n              <mxPoint x=\"627\" y=\"332.97\" />\n            </Array>\n            <mxPoint x=\"-126\" y=\"-123\" as=\"offset\" />\n            <mxPoint x=\"601\" y=\"332.97\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-12\" value=\"11 :&amp;amp;nbsp;btif_av_execute_service\" style=\"html=1;align=center;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"-1\" y=\"-126\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"601\" y=\"341.0044827586207\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"632\" y=\"340.97\" />\n              <mxPoint x=\"632\" y=\"356.97\" />\n            </Array>\n            <mxPoint x=\"-126\" y=\"-126\" as=\"offset\" />\n            <mxPoint x=\"606\" y=\"356.97\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"i7AMze4YFhcT6QFR-0tq-5\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"576\" y=\"260\" width=\"10\" height=\"145\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-14\" value=\"8 :&amp;amp;nbsp;bta_av_co_init\" style=\"html=1;align=center;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"-1\" y=\"-91\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"586.01\" y=\"270.0044827586207\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"617.01\" y=\"269.97\" />\n              <mxPoint x=\"617.01\" y=\"285.97\" />\n            </Array>\n            <mxPoint x=\"-91\" y=\"-83\" as=\"offset\" />\n            <mxPoint x=\"591.01\" y=\"285.97\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-15\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"581.01\" y=\"281.47\" width=\"10\" height=\"121\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-9\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"586\" y=\"305.47\" width=\"10\" height=\"94\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-16\" value=\"13 :&amp;amp;nbsp;bta_sys_register\" style=\"html=1;align=center;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"-0.1507\" y=\"33\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"733\" y=\"381.0044827586207\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"764\" y=\"380.97\" />\n              <mxPoint x=\"764\" y=\"396.97\" />\n            </Array>\n            <mxPoint x=\"-2\" y=\"-10\" as=\"offset\" />\n            <mxPoint x=\"738\" y=\"396.97\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-17\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"728\" y=\"389.47\" width=\"10\" height=\"27.53\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-18\" value=\"&amp;lt;b&amp;gt;bta_av_main&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"790\" y=\"80\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-19\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"855\" y=\"480\" as=\"sourcePoint\" />\n            <mxPoint x=\"855\" y=\"120\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-22\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"850\" y=\"412\" width=\"10\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-23\" value=\"&amp;amp;nbsp; bta_sys_sendmsg&amp;lt;br&amp;gt;BTA_AV_API_ENABLE_EVT\" style=\"html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" target=\"acxEuUhCBgighp4bq1Pn-22\" edge=\"1\">\n          <mxGeometry x=\"-0.5197\" y=\"-40\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"738.0000000000002\" y=\"413\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"753\" y=\"413\" />\n            </Array>\n            <mxPoint x=\"812\" y=\"420\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-24\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"-0.163\" y=\"-19\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"606\" y=\"390\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"626\" y=\"390\" />\n            </Array>\n            <mxPoint x=\"723\" y=\"390\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-11\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"591\" y=\"327.47\" width=\"10\" height=\"69\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"acxEuUhCBgighp4bq1Pn-13\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"596\" y=\"351.47\" width=\"10\" height=\"42\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"FCJ9blFmo7zwYH-58FEL-1\" value=\"4 : sBluetoothA2dpInterface-&amp;amp;gt;Init\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"372\" y=\"175\" width=\"200\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"FCJ9blFmo7zwYH-58FEL-3\" value=\"&amp;amp;nbsp; 12 : BTA_AvEnable\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"592\" y=\"354\" width=\"130\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"FCJ9blFmo7zwYH-58FEL-4\" value=\"&amp;amp;nbsp; 14 : BTA_AvRegister\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"590\" y=\"384\" width=\"140\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"FCJ9blFmo7zwYH-58FEL-5\" value=\"10 :&amp;amp;nbsp;btif_enable_service\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"418\" y=\"308\" width=\"150\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"FCJ9blFmo7zwYH-58FEL-6\" value=\"7 : btif_a2dp_source_startup&amp;lt;br style=&amp;quot;border-color: var(--border-color); font-size: 11px;&amp;quot;&amp;gt;启动media task\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"391\" y=\"233\" width=\"180\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n      </root>\n    </mxGraphModel>\n  </diagram>\n</mxfile>\n"}'></div><script type=text/javascript src=https://viewer.diagrams.net/js/viewer-static.min.js></script></div><h3 id=创建media-task>创建Media task
<a class=header-anchor href=#%e5%88%9b%e5%bb%bamedia-task></a></h3><p>btif_a2dp_source_startup函数创建了media task线程，设置a2dp控制命令处理函数:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* Start A2DP Source media task */</span>
</span></span><span class=line><span class=cl><span class=n>btif_a2dp_source_cb</span><span class=p>.</span><span class=n>worker_thread</span> <span class=o>=</span> <span class=n>thread_new_sized</span><span class=p>(</span><span class=s>&#34;media_worker&#34;</span><span class=p>,</span> <span class=n>MAX_MEDIA_WORKQUEUE_SEM_COUNT</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>btif_a2dp_source_cb</span><span class=p>.</span><span class=n>worker_thread</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>APPL_TRACE_ERROR</span><span class=p>(</span><span class=s>&#34;%s: unable to start up media thread&#34;</span><span class=p>,</span> <span class=n>__func__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>btif_a2dp_source_state</span> <span class=o>=</span> <span class=n>BTIF_A2DP_SOURCE_STATE_OFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>btif_a2dp_source_cb</span><span class=p>.</span><span class=n>tx_audio_queue</span> <span class=o>=</span> <span class=n>fixed_queue_new</span><span class=p>(</span><span class=n>SIZE_MAX</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>btif_a2dp_source_cb</span><span class=p>.</span><span class=n>cmd_msg_queue</span> <span class=o>=</span> <span class=n>fixed_queue_new</span><span class=p>(</span><span class=n>SIZE_MAX</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>fixed_queue_register_dequeue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>btif_a2dp_source_cb</span><span class=p>.</span><span class=n>cmd_msg_queue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>thread_get_reactor</span><span class=p>(</span><span class=n>btif_a2dp_source_cb</span><span class=p>.</span><span class=n>worker_thread</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=n>btif_a2dp_source_command_ready</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span></code></pre></div><p><code>thread_new_sized("media_worker", MAX_MEDIA_WORKQUEUE_SEM_COUNT)</code>创建media task线程。该线程主要负责a2dp数据发送处理及a2dp控制命令处理。
<code>fixed_queue_register_dequeue</code>把<code>cmd_msg_queue</code>传递给media task处理，处理函数是<code>btif_a2dp_source_command_ready</code>，主要处理a2dp相关控制命令:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* BTIF Media Source event definition */</span>
</span></span><span class=line><span class=cl><span class=k>enum</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_MEDIA_AUDIO_TX_START</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_MEDIA_AUDIO_TX_STOP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_MEDIA_AUDIO_TX_FLUSH</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_MEDIA_SOURCE_ENCODER_INIT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_MEDIA_SOURCE_ENCODER_USER_CONFIG_UPDATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_MEDIA_AUDIO_FEEDING_UPDATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_MEDIA_RESET_VS_STATE</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h3 id=初始化codec>初始化codec
<a class=header-anchor href=#%e5%88%9d%e5%a7%8b%e5%8c%96codec></a></h3><p>codec参数源于bluetooth app层，包括software和offload两类，传递流程如下：<br>A2dpService&ndash;>A2dpNativeInterface&ndash;>JNI&ndash;>btif_av&ndash;>bta_av_co<br>software参数由A2dpCodecConfig构造：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>A2dpCodecConfig</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>,</span> <span class=n>A2dpNativeInterface</span> <span class=n>a2dpNativeInterface</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mContext</span> <span class=o>=</span> <span class=n>context</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mA2dpNativeInterface</span> <span class=o>=</span> <span class=n>a2dpNativeInterface</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mCodecConfigPriorities</span> <span class=o>=</span> <span class=n>assignCodecConfigPriorities</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><code>assignCodecConfigPriorities()</code>获取config.xml文件中的codec配置<br>offload参数通过AudioManager接口获取<br>btif_av获取codec参数保存到<code>codecs_priorities_</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>bta_av_co_init</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>btav_a2dp_codec_config_t</span><span class=o>&gt;&amp;</span> <span class=n>codec_priorities</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>btav_a2dp_codec_config_t</span><span class=o>&gt;&amp;</span> <span class=n>offload_enabled_codecs_config</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=nl>config</span> <span class=p>:</span> <span class=n>codec_priorities</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>codecs_priorities_</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_pair</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>codec_type</span><span class=p>,</span> <span class=n>config</span><span class=p>.</span><span class=n>codec_priority</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//把支持的codec按照优先级排序
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>p_peer</span><span class=o>-&gt;</span><span class=n>codecs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>A2dpCodecs</span><span class=p>(</span><span class=n>codec_priorities</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>p_peer</span><span class=o>-&gt;</span><span class=n>codecs</span><span class=o>-&gt;</span><span class=n>init</span><span class=p>(</span><span class=n>isMcastSupported</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>......</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>bta_av_co根据<code>codecs_priorities_</code>获取本地支持的codec</p><h3 id=初始化btif-sm>初始化btif SM
<a class=header-anchor href=#%e5%88%9d%e5%a7%8b%e5%8c%96btif-sm></a></h3><p>btif_sm_init初始化btif层状态机，状态机定义如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>typedef</span> <span class=k>enum</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_AV_STATE_IDLE</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_AV_STATE_OPENING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_AV_STATE_OPENED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_AV_STATE_STARTED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>BTIF_AV_STATE_CLOSING</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>btif_av_state_t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=n>btif_sm_handler_t</span> <span class=n>btif_av_state_handlers</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>btif_av_state_idle_handler</span><span class=p>,</span> <span class=n>btif_av_state_opening_handler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>btif_av_state_opened_handler</span><span class=p>,</span> <span class=n>btif_av_state_started_handler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>btif_av_state_closing_handler</span><span class=p>};</span>
</span></span></code></pre></div><h3 id=初始化a2dp服务>初始化a2dp服务
<a class=header-anchor href=#%e5%88%9d%e5%a7%8b%e5%8c%96a2dp%e6%9c%8d%e5%8a%a1></a></h3><p>BTA_AvEnable注册bta处理函数<code>bta_sys_register(BTA_ID_AV, &amp;bta_av_reg)</code>，设置支持的Feature。
BTA_AvRegister用于向stack注册audio service，bta层对应的处理函数是bta_av_api_register，主要功能包括分配并初始化tBTA_AV_SCB（Stream Control Block）结构，创建并注册SDP服务记录。</p><h2 id=a2dp连接过程>A2DP连接过程
<a class=header-anchor href=#a2dp%e8%bf%9e%e6%8e%a5%e8%bf%87%e7%a8%8b></a></h2><div align=center><div class=mxgraph style="max-width:100%;border:1px solid transparent" data-mxgraph='{"highlight":"#0000ff","nav":true,"resize":true,"toolbar":"zoom layers tags lightbox","edit":"_blank","xml":"<mxfile host=\"app.diagrams.net\" modified=\"2023-10-30T01:11:41.532Z\" agent=\"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\" etag=\"mi5VOHyue0iMETeYb0Bc\" version=\"22.0.6\" type=\"device\">\n  <diagram name=\"第 1 页\" id=\"P-Dsk4ujABo6LbQ4KsAQ\">\n    <mxGraphModel dx=\"3789\" dy=\"2515\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"0\" pageScale=\"1\" pageWidth=\"827\" pageHeight=\"1169\" math=\"0\" shadow=\"0\">\n      <root>\n        <mxCell id=\"0\" />\n        <mxCell id=\"1\" parent=\"0\" />\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-1\" value=\"&amp;lt;b&amp;gt;A2dpService&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2690\" y=\"-1870\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-2\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2640\" y=\"-950\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2640\" y=\"-1829\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-3\" value=\"&amp;lt;b&amp;gt;A2dp JNI&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2550\" y=\"-1870\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-4\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2500\" y=\"-950\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2500\" y=\"-1829\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-5\" value=\"\" style=\"endArrow=classic;html=1;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2640\" y=\"-1800\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2505\" y=\"-1800\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-6\" value=\"1 : connectA2dpNative\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2645\" y=\"-1830\" width=\"140\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-7\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2505\" y=\"-1808\" width=\"10\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-8\" value=\"&amp;lt;b&amp;gt;btif_av&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2360\" y=\"-1870\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-9\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2310\" y=\"-950\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2310\" y=\"-1829\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-10\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2315\" y=\"-1791\" width=\"10\" height=\"74\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-11\" value=\"2 : connect\" style=\"html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2494\" y=\"-1787\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2315\" y=\"-1787\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-12\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2310\" y=\"-1774\" width=\"10\" height=\"54\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-13\" value=\"3 : connect_int\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"0.0094\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2305\" y=\"-1785\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-2274\" y=\"-1785\" />\n              <mxPoint x=\"-2274\" y=\"-1770\" />\n            </Array>\n            <mxPoint as=\"offset\" />\n            <mxPoint x=\"-2300\" y=\"-1770\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-14\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2305\" y=\"-1751\" width=\"10\" height=\"28\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-15\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2300\" y=\"-1762\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-2269\" y=\"-1762\" />\n              <mxPoint x=\"-2269\" y=\"-1747\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-2295\" y=\"-1747\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-16\" value=\"&amp;lt;b&amp;gt;bta_av_api&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2213\" y=\"-1870\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-17\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2163\" y=\"-950\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2163\" y=\"-1829\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-18\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2168\" y=\"-1732\" width=\"10\" height=\"20\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-19\" value=\"5 : BTA_AvOpen\" style=\"html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2294\" y=\"-1730\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2168\" y=\"-1730\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-20\" value=\"&amp;lt;b&amp;gt;bta_av_main&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2021\" y=\"-1870\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-21\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;strokeWidth=1;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1969\" y=\"-950\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1969\" y=\"-1829\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-22\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1975\" y=\"-1722\" width=\"10\" height=\"21\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-23\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0201\" y=\"8\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2158\" y=\"-1720\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1975\" y=\"-1720\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-24\" value=\"&amp;lt;b&amp;gt;bta_av_aact&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1869\" y=\"-1870\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-25\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1819\" y=\"-950\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1819\" y=\"-1829\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-26\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1824\" y=\"-1711\" width=\"10\" height=\"23\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-27\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"0.0843\" y=\"11\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1965\" y=\"-1709\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1824\" y=\"-1709\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-28\" value=\"7 :&amp;amp;nbsp;bta_av_do_disc_a2dp\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1974\" y=\"-1737\" width=\"160\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-29\" value=\"&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;4 : btif_sm_dispatch&amp;lt;br style=&amp;quot;border-color: var(--border-color); font-size: 11px; text-align: left;&amp;quot;&amp;gt;&amp;lt;span style=&amp;quot;font-size: 11px; text-align: left;&amp;quot;&amp;gt;BTIF_AV_CONNECT_REQ_EVT&amp;lt;/span&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2507\" y=\"-1779\" width=\"200\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-30\" value=\"6 : bta_sys_sendmsg&amp;lt;br style=&amp;quot;border-color: var(--border-color); font-size: 11px; text-align: left;&amp;quot;&amp;gt;&amp;lt;span style=&amp;quot;border-color: var(--border-color); font-size: 11px; text-align: left;&amp;quot;&amp;gt;BTIF_AV_CONNECT_REQ_EVT&amp;lt;/span&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2166\" y=\"-1758.5\" width=\"200\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-32\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1814\" y=\"-1507\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1783\" y=\"-1507\" />\n              <mxPoint x=\"-1783\" y=\"-1492\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1809\" y=\"-1492\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-34\" value=\"&amp;lt;b&amp;gt;SDP&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1709\" y=\"-1870\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-35\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1659\" y=\"-950\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1659\" y=\"-1829\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-37\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1664\" y=\"-1698\" width=\"10\" height=\"22\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-38\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"0.0843\" y=\"11\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1814\" y=\"-1695\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1664\" y=\"-1695\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-39\" value=\"8 :&amp;amp;nbsp;A2DP_FindService&amp;lt;br&amp;gt;connect sdp &amp;amp;amp; search\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1811\" y=\"-1732.5\" width=\"140\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-40\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1659\" y=\"-1670\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1814\" y=\"-1670\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-41\" value=\"9 :&amp;amp;nbsp;bta_av_a2dp_sdp_cback\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1821\" y=\"-1673\" width=\"170\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-42\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1822\" y=\"-1650\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1964\" y=\"-1650\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-43\" value=\"10 : bta_sys_sendmsg&amp;lt;br style=&amp;quot;border-color: var(--border-color); font-size: 11px; text-align: left;&amp;quot;&amp;gt;&amp;lt;span style=&amp;quot;border-color: var(--border-color); font-size: 11px; text-align: left;&amp;quot;&amp;gt;BTA_AV_SDP_DISC_OK_EVT&amp;lt;/span&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2153\" y=\"-1673\" width=\"190\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-45\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1824\" y=\"-1672\" width=\"10\" height=\"26\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-46\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1974\" y=\"-1652\" width=\"10\" height=\"33\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-47\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1824\" y=\"-1625\" width=\"10\" height=\"26\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-49\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"0.0843\" y=\"11\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1964\" y=\"-1623\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1824\" y=\"-1623\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-50\" value=\"11 :&amp;amp;nbsp;bta_av_connect_req\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1969\" y=\"-1629\" width=\"150\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-51\" value=\"&amp;lt;b&amp;gt;avdt_api&amp;lt;br&amp;gt;avdtp STACK&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1595\" y=\"-1870\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-52\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1545\" y=\"-950\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1545\" y=\"-1829\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-53\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1550\" y=\"-1608\" width=\"10\" height=\"84\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-54\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"0.0843\" y=\"11\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1814\" y=\"-1604\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1551\" y=\"-1604\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-55\" value=\"12 : AVDT_ConnectReq\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1761\" y=\"-1632\" width=\"150\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-56\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1545\" y=\"-1591\" width=\"10\" height=\"64\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-57\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1540\" y=\"-1602\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1509\" y=\"-1602\" />\n              <mxPoint x=\"-1509\" y=\"-1587\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1535\" y=\"-1587\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-58\" value=\"13 : 执行ccb状态机&amp;lt;br&amp;gt;建立l2cap连接\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1669\" y=\"-1605\" width=\"130\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-60\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"0.0843\" y=\"11\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1545\" y=\"-1515\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1813\" y=\"-1515\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-61\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1824\" y=\"-1519\" width=\"10\" height=\"65\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-62\" value=\"15 :&amp;amp;nbsp;bta_av_stream0_cback&amp;lt;br&amp;gt;AVDT_CONNECT_IND_EVT\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1826\" y=\"-1552\" width=\"180\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-31\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1819\" y=\"-1496\" width=\"10\" height=\"39\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-63\" value=\"16 : bta_av_proc_stream_evt&amp;lt;br&amp;gt;AVDT事件映射为BTA事件\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1807\" y=\"-1495\" width=\"180\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-64\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1820\" y=\"-1462\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1964\" y=\"-1462\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-65\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1974\" y=\"-1464\" width=\"10\" height=\"33\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-66\" value=\"17 : bta_sys_sendmsg&amp;lt;br style=&amp;quot;border-color: var(--border-color); font-size: 11px; text-align: left;&amp;quot;&amp;gt;&amp;lt;div style=&amp;quot;text-align: left;&amp;quot;&amp;gt;BTA_AV_AVDT_CONNECT_EVT&amp;lt;/div&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2166\" y=\"-1483\" width=\"200\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-67\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1824\" y=\"-1437\" width=\"10\" height=\"26\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-68\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"0.0843\" y=\"11\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1964\" y=\"-1435\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1824\" y=\"-1435\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-69\" value=\"18 :&amp;amp;nbsp;bta_av_discover_req\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1977\" y=\"-1440\" width=\"160\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-71\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"0.0843\" y=\"11\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1814\" y=\"-1416\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1551\" y=\"-1416\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-72\" value=\"19 : AVDT_DiscoverReq\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1756\" y=\"-1444\" width=\"150\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-75\" value=\"20 : 执行ccb状态机&amp;lt;br&amp;gt;send Discover\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1671\" y=\"-1418\" width=\"130\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-76\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1540\" y=\"-1553\" width=\"10\" height=\"23\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-77\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1535\" y=\"-1564\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1504\" y=\"-1564\" />\n              <mxPoint x=\"-1504\" y=\"-1549\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1530\" y=\"-1549\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-78\" value=\"14 ： avdt_ccb_ll_opened\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1702\" y=\"-1570\" width=\"160\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-79\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1550\" y=\"-1419\" width=\"10\" height=\"84\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-80\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1545\" y=\"-1402\" width=\"10\" height=\"64\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-81\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1540\" y=\"-1413\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1509\" y=\"-1413\" />\n              <mxPoint x=\"-1509\" y=\"-1398\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1535\" y=\"-1398\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-82\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1540\" y=\"-1364\" width=\"10\" height=\"23\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-83\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1535\" y=\"-1375\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1504\" y=\"-1375\" />\n              <mxPoint x=\"-1504\" y=\"-1360\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1530\" y=\"-1360\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-84\" value=\"21 ：&amp;amp;nbsp;avdt_ccb_hdl_discover_rsp\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1754\" y=\"-1385\" width=\"200\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-85\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1815\" y=\"-1321\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1784\" y=\"-1321\" />\n              <mxPoint x=\"-1784\" y=\"-1306\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1810\" y=\"-1306\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-86\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"0.0843\" y=\"11\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1546\" y=\"-1329\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1814\" y=\"-1329\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-87\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1825\" y=\"-1333\" width=\"10\" height=\"65\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-88\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1820\" y=\"-1310\" width=\"10\" height=\"39\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-89\" value=\"23 : bta_av_proc_stream_evt&amp;lt;br&amp;gt;AVDT事件映射为BTA事件\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1808\" y=\"-1309\" width=\"180\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-90\" value=\"22 :&amp;amp;nbsp;bta_av_stream0_cback&amp;lt;br&amp;gt;AVDT_DISCOVER_CFM_EVT\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1829\" y=\"-1367.5\" width=\"190\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-91\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1974\" y=\"-1286\" width=\"10\" height=\"33\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-92\" value=\"24 : bta_sys_sendmsg&amp;lt;br style=&amp;quot;border-color: var(--border-color); font-size: 11px; text-align: left;&amp;quot;&amp;gt;&amp;lt;div style=&amp;quot;text-align: left;&amp;quot;&amp;gt;BTA_AV_STR_DISC_OK_EVT&amp;lt;br&amp;gt;&amp;lt;/div&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2161\" y=\"-1305\" width=\"190\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-93\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1820\" y=\"-1279\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1964\" y=\"-1279\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-94\" value=\"&amp;lt;b&amp;gt;根据Discover返回的SEP数量，逐个获取capabilities，并根据本地支持的codec，选择需要配置的codec&amp;lt;br&amp;gt;&amp;lt;/b&amp;gt;\" style=\"shape=note;size=20;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2150\" y=\"-1251\" width=\"620\" height=\"41\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-95\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1819\" y=\"-1170\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2157\" y=\"-1170\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-96\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2168\" y=\"-1174\" width=\"10\" height=\"44\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-97\" value=\"25 :&amp;amp;nbsp;AVDT_OpenReq\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2109\" y=\"-1195\" width=\"140\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-98\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2158\" y=\"-1134\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1550\" y=\"-1134\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-99\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1550\" y=\"-1137\" width=\"10\" height=\"170\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-100\" value=\"26 :&amp;amp;nbsp;avdt_scb_event&amp;lt;br&amp;gt;AVDT_SCB_API_SETCONFIG_REQ_EVT\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2012\" y=\"-1171\" width=\"250\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-101\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1545\" y=\"-1117\" width=\"10\" height=\"147\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-102\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1540\" y=\"-1128\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1509\" y=\"-1128\" />\n              <mxPoint x=\"-1509\" y=\"-1113\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1535\" y=\"-1113\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-103\" value=\"27 : 执行scb状态机&amp;lt;br&amp;gt;send set config\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1713\" y=\"-1137\" width=\"130\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-104\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1540\" y=\"-1091\" width=\"10\" height=\"118\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-105\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1535\" y=\"-1102\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1504\" y=\"-1102\" />\n              <mxPoint x=\"-1504\" y=\"-1087\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1530\" y=\"-1087\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-106\" value=\"28 :&amp;amp;nbsp;avdt_scb_snd_setconfig_req\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1746\" y=\"-1105\" width=\"200\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-107\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1535\" y=\"-1066\" width=\"10\" height=\"90\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-108\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1530\" y=\"-1077\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1499\" y=\"-1077\" />\n              <mxPoint x=\"-1499\" y=\"-1062\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1525\" y=\"-1062\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-109\" value=\"29 :&amp;amp;nbsp;avdt_scb_event&amp;lt;br&amp;gt;AVDT_SCB_MSG_SETCONFIG_RSP_EVT\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1801\" y=\"-1091\" width=\"260\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-111\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1530\" y=\"-1042\" width=\"10\" height=\"63\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-112\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1525\" y=\"-1054\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1494\" y=\"-1054\" />\n              <mxPoint x=\"-1494\" y=\"-1039\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1520\" y=\"-1039\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-113\" value=\"30 :&amp;amp;nbsp;avdt_scb_hdl_setconfig_rsp\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1748\" y=\"-1062\" width=\"200\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-114\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1525\" y=\"-1020\" width=\"10\" height=\"38\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-115\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1520\" y=\"-1032\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1489\" y=\"-1032\" />\n              <mxPoint x=\"-1489\" y=\"-1017\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1515\" y=\"-1017\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-116\" value=\"31 :&amp;amp;nbsp;avdt_scb_event&amp;lt;br&amp;gt;AVDT_SCB_API_OPEN_REQ_EVT\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1759\" y=\"-1046\" width=\"220\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-117\" value=\"32 :&amp;amp;nbsp;avdt_scb_snd_open_req\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1721\" y=\"-1015\" width=\"180\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-118\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1520\" y=\"-998\" width=\"10\" height=\"14\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-119\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;strokeColor=#A8201A;fontColor=default;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1515\" y=\"-1010\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1484\" y=\"-1010\" />\n              <mxPoint x=\"-1484\" y=\"-995\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1510\" y=\"-995\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n      </root>\n    </mxGraphModel>\n  </diagram>\n</mxfile>\n"}'></div><script type=text/javascript src=https://viewer.diagrams.net/js/viewer-static.min.js></script><script type=text/javascript src=https://viewer.diagrams.net/js/viewer-static.min.js></script><script type=text/javascript src=https://viewer.diagrams.net/js/viewer-static.min.js></script></div><p>整个流程主要在signal channel上交互，最后执行Open请求，建立media channel<br>协议数据接收处理位于avdt_l2c.cc</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* L2CAP callback function structure */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>tL2CAP_APPL_INFO</span> <span class=n>avdt_l2c_appl</span> <span class=o>=</span> <span class=p>{</span><span class=n>avdt_l2c_connect_ind_cback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=n>avdt_l2c_connect_cfm_cback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=n>avdt_l2c_config_ind_cback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=n>avdt_l2c_config_cfm_cback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=n>avdt_l2c_disconnect_ind_cback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=n>avdt_l2c_disconnect_cfm_cback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=n>avdt_l2c_data_ind_cback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=n>avdt_l2c_congestion_ind_cback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=nb>NULL</span><span class=p>,</span> <span class=cm>/* tL2CA_TX_COMPLETE_CB */</span>
</span></span><span class=line><span class=cl>                                        <span class=nb>NULL</span> <span class=cm>/* tL2CA_CREDITS_RECEIVED_CB */</span><span class=p>};</span>
</span></span></code></pre></div><h3 id=codec配置>codec配置
<a class=header-anchor href=#codec%e9%85%8d%e7%bd%ae></a></h3><p>根据discover到的sep数量,逐个获取codec信息,并检查是否有本地匹配的codec配置<br>bta_av_getcap_results中执行p_scb->p_cos->getcfg检查本地codec配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>tA2DP_STATUS</span> <span class=nf>bta_av_co_audio_getconfig</span><span class=p>(</span><span class=n>tBTA_AV_HNDL</span> <span class=n>hndl</span><span class=p>,</span> <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>p_codec_info</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                       <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>p_sep_info_idx</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>seid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                       <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>p_num_protect</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                       <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>p_protect_info</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>tBTA_AV_CO_PEER</span><span class=o>*</span> <span class=n>p_peer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Retrieve the peer info */</span>
</span></span><span class=line><span class=cl>  <span class=n>p_peer</span> <span class=o>=</span> <span class=n>bta_av_co_get_peer</span><span class=p>(</span><span class=n>hndl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>p_peer</span><span class=o>-&gt;</span><span class=n>num_rx_sinks</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>......</span>
</span></span><span class=line><span class=cl>  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>remote_bd_addr_str</span> <span class=o>=</span> <span class=n>p_peer</span><span class=o>-&gt;</span><span class=n>addr</span><span class=p>.</span><span class=n>ToString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>remote_bdstr</span>  <span class=o>=</span> <span class=n>remote_bd_addr_str</span><span class=p>.</span><span class=n>c_str</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>bta_av_co_check_and_add_soc_supported_codecs</span><span class=p>(</span><span class=n>p_codec_info</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Check if this is the last SINK get capabilities or all supported codec
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// capabilities are retrieved.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>((</span><span class=n>p_peer</span><span class=o>-&gt;</span><span class=n>num_rx_sinks</span> <span class=o>!=</span> <span class=n>p_peer</span><span class=o>-&gt;</span><span class=n>num_sinks</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=n>p_peer</span><span class=o>-&gt;</span><span class=n>num_sup_sinks</span> <span class=o>!=</span> <span class=n>BTA_AV_CO_NUM_ELEMENTS</span><span class=p>(</span><span class=n>p_peer</span><span class=o>-&gt;</span><span class=n>sinks</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>A2DP_FAIL</span><span class=p>;</span><span class=c1>//等到遍历完所有sep后才往下走
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>//选择双方都支持的最优先的codec配置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>const</span> <span class=n>tBTA_AV_CO_SINK</span><span class=o>*</span> <span class=n>p_sink</span> <span class=o>=</span> <span class=n>bta_av_co_audio_set_codec</span><span class=p>(</span><span class=n>p_peer</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>......</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>A2DP_SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=ccb状态机>ccb状态机
<a class=header-anchor href=#ccb%e7%8a%b6%e6%80%81%e6%9c%ba></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* state table */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>tAVDT_CCB_ST_TBL</span> <span class=n>avdt_ccb_st_tbl</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>avdt_ccb_st_idle</span><span class=p>,</span> <span class=n>avdt_ccb_st_opening</span><span class=p>,</span> <span class=n>avdt_ccb_st_open</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>avdt_ccb_st_closing</span><span class=p>};</span>
</span></span></code></pre></div><p>AVDT_ConnectReq建立avdtp signal channel, 进入idle状态表,执行API_CONNECT_REQ_EVT对应action建立l2cap连接,状态切换到opening<br>连接完成后发送LL_OPEN_EVT到ccb, 进入avdt_ccb_st_opening状态表,执行AVDT_CONNECT_IND_EVT事件的BTA回调处理，状态切换到open状态,后续signal channel交互都处于open状态。</p><h3 id=scb状态机>scb状态机
<a class=header-anchor href=#scb%e7%8a%b6%e6%80%81%e6%9c%ba></a></h3><p>scb状态机
第一个event是set config req（4）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>uint16_t</span> <span class=nf>AVDT_OpenReq</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>handle</span><span class=p>,</span> <span class=k>const</span> <span class=n>RawAddress</span><span class=o>&amp;</span> <span class=n>bd_addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>seid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>tAVDT_CFG</span><span class=o>*</span> <span class=n>p_cfg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>......</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* send event to scb */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>AVDT_SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>A2DP_DumpCodecInfo</span><span class=p>(</span><span class=n>p_cfg</span><span class=o>-&gt;</span><span class=n>codec_info</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>evt</span><span class=p>.</span><span class=n>msg</span><span class=p>.</span><span class=n>config_cmd</span><span class=p>.</span><span class=n>hdr</span><span class=p>.</span><span class=n>seid</span> <span class=o>=</span> <span class=n>seid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>evt</span><span class=p>.</span><span class=n>msg</span><span class=p>.</span><span class=n>config_cmd</span><span class=p>.</span><span class=n>hdr</span><span class=p>.</span><span class=n>ccb_idx</span> <span class=o>=</span> <span class=nf>avdt_ccb_to_idx</span><span class=p>(</span><span class=n>p_ccb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>evt</span><span class=p>.</span><span class=n>msg</span><span class=p>.</span><span class=n>config_cmd</span><span class=p>.</span><span class=n>int_seid</span> <span class=o>=</span> <span class=n>handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>evt</span><span class=p>.</span><span class=n>msg</span><span class=p>.</span><span class=n>config_cmd</span><span class=p>.</span><span class=n>p_cfg</span> <span class=o>=</span> <span class=n>p_cfg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>avdt_scb_event</span><span class=p>(</span><span class=n>p_scb</span><span class=p>,</span> <span class=n>AVDT_SCB_API_SETCONFIG_REQ_EVT</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>evt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>a2dp建立完成后和audio模块的交互过程如下：</p><div align=center><div class=mxgraph style="max-width:100%;border:1px solid transparent" data-mxgraph='{"highlight":"#0000ff","nav":true,"resize":true,"toolbar":"zoom layers tags lightbox","edit":"_blank","xml":"<mxfile host=\"app.diagrams.net\" modified=\"2023-10-30T08:22:20.096Z\" agent=\"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\" etag=\"puY-TXfhgT163KY9GnEi\" version=\"22.0.6\" type=\"device\">\n  <diagram name=\"第 1 页\" id=\"P-Dsk4ujABo6LbQ4KsAQ\">\n    <mxGraphModel dx=\"3995\" dy=\"1823\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"0\" pageScale=\"1\" pageWidth=\"827\" pageHeight=\"1169\" math=\"0\" shadow=\"0\">\n      <root>\n        <mxCell id=\"0\" />\n        <mxCell id=\"1\" parent=\"0\" />\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-120\" value=\"&amp;lt;b&amp;gt;btif_av&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1840\" y=\"-880\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-121\" value=\"&amp;lt;b&amp;gt;Audio Module&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2410\" y=\"-880\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-122\" value=\"&amp;lt;b&amp;gt;bluetooth audio&amp;lt;br&amp;gt;HAL&amp;lt;br&amp;gt;&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2269\" y=\"-880\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-123\" value=\"&amp;lt;b&amp;gt;avdt_api&amp;lt;br&amp;gt;avdtp STACK&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1549\" y=\"-880\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-124\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2360\" y=\"-840\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2360\" y=\"-400\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-125\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2220\" y=\"-840\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2220\" y=\"-400\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-126\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1499\" y=\"-840\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1499\" y=\"-400\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-127\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1791\" y=\"-840\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1791\" y=\"-400\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-128\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1504\" y=\"-819\" width=\"10\" height=\"53\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-129\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;movable=1;resizable=1;rotatable=1;deletable=1;editable=1;locked=0;connectable=1;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1499\" y=\"-831\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1468\" y=\"-831\" />\n              <mxPoint x=\"-1468\" y=\"-816\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1494\" y=\"-816\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-130\" value=\"1 :&amp;amp;nbsp;avdt_scb_hdl_open_rsp\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1658\" y=\"-842\" width=\"170\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-131\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1499\" y=\"-800\" width=\"10\" height=\"31\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-132\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1494\" y=\"-808\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1463\" y=\"-808\" />\n              <mxPoint x=\"-1463\" y=\"-793\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1489\" y=\"-793\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-133\" value=\"2 :&amp;amp;nbsp;avdt_ad_open_req&amp;lt;br&amp;gt;创建media chan连接\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1645\" y=\"-823\" width=\"140\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-136\" value=\"&amp;lt;b&amp;gt;BTA&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1700\" y=\"-880\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-137\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1651.0000000000002\" y=\"-840\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1651.0000000000002\" y=\"-400\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-138\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1499\" y=\"-770\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1651\" y=\"-770\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-139\" value=\"3 ：bta_av_stream0_cback&amp;amp;nbsp;&amp;lt;br&amp;gt;AVDT_OPEN_CFM_EVT\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1661\" y=\"-791\" width=\"170\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-141\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1656\" y=\"-742\" width=\"10\" height=\"23\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-142\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1651\" y=\"-750\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1620\" y=\"-750\" />\n              <mxPoint x=\"-1620\" y=\"-735\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1646\" y=\"-735\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-143\" value=\"4 : bta_av_str_opened\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1629\" y=\"-757\" width=\"140\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-144\" value=\"5 : bte_av_callback&amp;lt;br&amp;gt;BTA_AV_OPEN_EVT\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1791\" y=\"-761\" width=\"140\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-145\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1656\" y=\"-723\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1784\" y=\"-723\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-146\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1795\" y=\"-727\" width=\"10\" height=\"47\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-147\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1790\" y=\"-707\" width=\"10\" height=\"23\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-148\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1785\" y=\"-715\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-1754\" y=\"-715\" />\n              <mxPoint x=\"-1754\" y=\"-700\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-1780\" y=\"-700\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-149\" value=\"6 : btif_report_connection_state\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1765\" y=\"-723\" width=\"190\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-150\" value=\"&amp;lt;b&amp;gt;A2dpService&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2120\" y=\"-880\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-151\" value=\"&amp;lt;b&amp;gt;A2dp JNI&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1980\" y=\"-880\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-152\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1929\" y=\"-840\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1929\" y=\"-400\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-153\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;\" edge=\"1\" parent=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2080\" y=\"-840\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2080\" y=\"-400\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-154\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1790\" y=\"-688\" as=\"sourcePoint\" />\n            <mxPoint x=\"-1922\" y=\"-688\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-155\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1934\" y=\"-690\" width=\"10\" height=\"31\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-156\" value=\"7 : bta2dp_connection_state_callback\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1926\" y=\"-690\" width=\"220\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-157\" value=\"8 : messageFromNative\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2078\" y=\"-685\" width=\"150\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-158\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-1934\" y=\"-662\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2073\" y=\"-662\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-159\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2085\" y=\"-664\" width=\"10\" height=\"24\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-160\" value=\"进入A2dp SM处理，发送广播：&amp;lt;br&amp;gt;BluetoothA2dp.ACTION_CONNECTION_STATE_CHANGED\" style=\"shape=note;size=20;whiteSpace=wrap;html=1;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2169\" y=\"-635\" width=\"333\" height=\"70\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-161\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2085\" y=\"-544\" width=\"10\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-162\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2080\" y=\"-552\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-2049\" y=\"-552\" />\n              <mxPoint x=\"-2049\" y=\"-537\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-2075\" y=\"-537\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-163\" value=\"9 :&amp;amp;nbsp;setActiveDevice\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2053\" y=\"-559\" width=\"130\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-164\" value=\"10 : handleBluetoothA2dpActiveDeviceChange\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2355\" y=\"-544\" width=\"270\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-165\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2085\" y=\"-519\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2353\" y=\"-519\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-166\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2365\" y=\"-521\" width=\"10\" height=\"18\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-168\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2365\" y=\"-491\" width=\"10\" height=\"25\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-169\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2360\" y=\"-499\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-2329\" y=\"-499\" />\n              <mxPoint x=\"-2329\" y=\"-484\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-2355\" y=\"-484\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-170\" value=\"11 :&amp;amp;nbsp;setBluetoothA2dpDeviceConnectionState\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2342\" y=\"-507\" width=\"270\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-171\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2365\" y=\"-453\" width=\"10\" height=\"33\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-172\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-1\" y=\"200\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2360\" y=\"-461\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"-2329\" y=\"-461\" />\n              <mxPoint x=\"-2329\" y=\"-446\" />\n            </Array>\n            <mxPoint x=\"-200\" y=\"192\" as=\"offset\" />\n            <mxPoint x=\"-2355\" y=\"-446\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-173\" value=\"12 :&amp;amp;nbsp;setBluetoothA2dpOnInt\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2338\" y=\"-469\" width=\"170\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-174\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#FAE5C7;strokeColor=#0F8B8D;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2225\" y=\"-428\" width=\"10\" height=\"23\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-175\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#A8201A;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"-0.0052\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"-2355\" y=\"-423\" as=\"sourcePoint\" />\n            <mxPoint x=\"-2225\" y=\"-423\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"AvUZbC0me2tCTHYIym_a-176\" value=\"13 : audio_open_output_stream\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"-2225\" y=\"-437\" width=\"190\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n      </root>\n    </mxGraphModel>\n  </diagram>\n</mxfile>\n"}'></div><script type=text/javascript src=https://viewer.diagrams.net/js/viewer-static.min.js></script></div><h2 id=a2dp音乐播放>A2DP音乐播放
<a class=header-anchor href=#a2dp%e9%9f%b3%e4%b9%90%e6%92%ad%e6%94%be></a></h2><div align=center><div class=mxgraph style="max-width:100%;border:1px solid transparent" data-mxgraph='{"highlight":"#0000ff","nav":true,"resize":true,"toolbar":"zoom layers tags lightbox","edit":"_blank","xml":"<mxfile host=\"app.diagrams.net\" modified=\"2023-11-21T09:06:09.491Z\" agent=\"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36\" etag=\"AqnPK1n63NnZSU0TdQh0\" version=\"22.1.3\" type=\"device\">\n  <diagram name=\"第 1 页\" id=\"P-Dsk4ujABo6LbQ4KsAQ\">\n    <mxGraphModel dx=\"1195\" dy=\"663\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"827\" pageHeight=\"1169\" math=\"0\" shadow=\"0\">\n      <root>\n        <mxCell id=\"0\" />\n        <mxCell id=\"1\" parent=\"0\" />\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-1\" value=\"&amp;lt;b&amp;gt;Audio Module&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"160\" y=\"40\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-2\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"209\" y=\"750\" as=\"sourcePoint\" />\n            <mxPoint x=\"209\" y=\"80\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-4\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"349\" y=\"750\" as=\"sourcePoint\" />\n            <mxPoint x=\"349\" y=\"80\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-6\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"485\" y=\"750\" as=\"sourcePoint\" />\n            <mxPoint x=\"485\" y=\"80\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-7\" value=\"&amp;lt;b&amp;gt;BTIF&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"571\" y=\"40\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-8\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"620\" y=\"750\" as=\"sourcePoint\" />\n            <mxPoint x=\"620\" y=\"80\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-9\" value=\"&amp;lt;b&amp;gt;BTA&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"721\" y=\"40\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-10\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"770\" y=\"750\" as=\"sourcePoint\" />\n            <mxPoint x=\"770\" y=\"80\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-11\" value=\"&amp;lt;b&amp;gt;Bluetooth Audio&amp;lt;br&amp;gt;HAL&amp;lt;br&amp;gt;&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"300\" y=\"40\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-12\" value=\"&amp;lt;b&amp;gt;bt audio hal&amp;lt;br&amp;gt;interface&amp;lt;br&amp;gt;&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"436\" y=\"40\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-13\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0063\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"209\" y=\"105\" as=\"sourcePoint\" />\n            <mxPoint x=\"344\" y=\"105\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-14\" value=\"1 : out_write\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"230\" y=\"82\" width=\"90\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-15\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"344\" y=\"101\" width=\"10\" height=\"96\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-16\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"349\" y=\"113\" width=\"10\" height=\"81\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-17\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"354\" y=\"104\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"354\" y=\"104\" />\n              <mxPoint x=\"384\" y=\"104\" />\n              <mxPoint x=\"384\" y=\"117\" />\n            </Array>\n            <mxPoint x=\"359\" y=\"117\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-19\" value=\"2 : out_resume\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"376\" y=\"95\" width=\"100\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-20\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"354\" y=\"134\" width=\"10\" height=\"57\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-21\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"359\" y=\"125\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"359\" y=\"125\" />\n              <mxPoint x=\"389\" y=\"125\" />\n              <mxPoint x=\"389\" y=\"138\" />\n            </Array>\n            <mxPoint x=\"364\" y=\"138\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-22\" value=\"3 :&amp;amp;nbsp;BluetoothAudioPortOut::Start()\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"153\" y=\"116\" width=\"200\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-23\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"359\" y=\"156\" width=\"10\" height=\"32\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-24\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"364\" y=\"147\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"364\" y=\"147\" />\n              <mxPoint x=\"394\" y=\"147\" />\n              <mxPoint x=\"394\" y=\"160\" />\n            </Array>\n            <mxPoint x=\"369\" y=\"160\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-25\" value=\"4 :&amp;amp;nbsp;BluetoothAudioSession::StartStream\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"122\" y=\"139\" width=\"230\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-26\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"480\" y=\"182\" width=\"10\" height=\"49\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-27\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"369\" y=\"186\" as=\"sourcePoint\" />\n            <mxPoint x=\"480\" y=\"186\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-28\" value=\"5 :&amp;amp;nbsp;startStream\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"366\" y=\"162\" width=\"100\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-29\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"485\" y=\"197\" width=\"10\" height=\"31\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-30\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"490\" y=\"188\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"490\" y=\"188\" />\n              <mxPoint x=\"520\" y=\"188\" />\n              <mxPoint x=\"520\" y=\"201\" />\n            </Array>\n            <mxPoint x=\"495\" y=\"201\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-31\" value=\"6 :&amp;amp;nbsp;StartRequest\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"510\" y=\"178\" width=\"110\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-32\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"615\" y=\"219\" width=\"10\" height=\"71\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-33\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"495\" y=\"224\" as=\"sourcePoint\" />\n            <mxPoint x=\"615\" y=\"224\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-34\" value=\"7 :&amp;amp;nbsp;btif_dispatch_sm_event&amp;lt;br&amp;gt;BTIF_AV_PROCESS_HIDL_REQ_EVT\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"258\" y=\"196\" width=\"230\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-35\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"620\" y=\"233\" width=\"10\" height=\"54\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-36\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"625\" y=\"224\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"625\" y=\"224\" />\n              <mxPoint x=\"655\" y=\"224\" />\n              <mxPoint x=\"655\" y=\"237\" />\n            </Array>\n            <mxPoint x=\"630\" y=\"237\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-37\" value=\"8 :&amp;amp;nbsp;btif_av_handle_event\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"620\" y=\"202\" width=\"150\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-38\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"625\" y=\"253\" width=\"10\" height=\"31\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-39\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"630\" y=\"244\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"630\" y=\"244\" />\n              <mxPoint x=\"660\" y=\"244\" />\n              <mxPoint x=\"660\" y=\"257\" />\n            </Array>\n            <mxPoint x=\"635\" y=\"257\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-40\" value=\"9 :&amp;amp;nbsp;btif_sm_dispatch\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"494\" y=\"238\" width=\"130\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-41\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"765\" y=\"275\" width=\"10\" height=\"22\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-42\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"635\" y=\"280\" as=\"sourcePoint\" />\n            <mxPoint x=\"765\" y=\"280\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-43\" value=\"10 :&amp;amp;nbsp;BTA_AvStart\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"633\" y=\"256\" width=\"120\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-44\" value=\"&amp;lt;b&amp;gt;BTU Task&amp;lt;/b&amp;gt;\" style=\"rounded=1;whiteSpace=wrap;html=1;labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"863\" y=\"40\" width=\"100\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-45\" value=\"\" style=\"endArrow=none;dashed=1;html=1;rounded=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"912\" y=\"750\" as=\"sourcePoint\" />\n            <mxPoint x=\"912\" y=\"80\" as=\"targetPoint\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-47\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"907\" y=\"287\" width=\"10\" height=\"86\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-48\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"775\" y=\"292\" as=\"sourcePoint\" />\n            <mxPoint x=\"907\" y=\"292\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-49\" value=\"11 :&amp;amp;nbsp;bta_sys_sendmsg&amp;lt;br style=&amp;quot;border-color: var(--border-color); font-size: 11px; text-align: left;&amp;quot;&amp;gt;&amp;lt;span style=&amp;quot;font-size: 11px; text-align: left; background-color: rgb(255, 255, 255);&amp;quot;&amp;gt;BTA_AV_API_START_EVT&amp;lt;/span&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"763\" y=\"251\" width=\"170\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-50\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"912\" y=\"301\" width=\"10\" height=\"69\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-51\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"917\" y=\"292\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"917\" y=\"292\" />\n              <mxPoint x=\"947\" y=\"292\" />\n              <mxPoint x=\"947\" y=\"305\" />\n            </Array>\n            <mxPoint x=\"922\" y=\"305\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-52\" value=\"12 :&amp;amp;nbsp;&amp;amp;nbsp;bta_av_do_start\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"778\" y=\"290\" width=\"140\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-53\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"917\" y=\"321\" width=\"10\" height=\"46\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-54\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"922\" y=\"312\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"922\" y=\"312\" />\n              <mxPoint x=\"952\" y=\"312\" />\n              <mxPoint x=\"952\" y=\"325\" />\n            </Array>\n            <mxPoint x=\"927\" y=\"325\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-55\" value=\"13 :&amp;amp;nbsp;AVDT_StartReq\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"782\" y=\"310\" width=\"130\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-56\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"922\" y=\"342\" width=\"10\" height=\"22\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-57\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"927\" y=\"333\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"927\" y=\"333\" />\n              <mxPoint x=\"957\" y=\"333\" />\n              <mxPoint x=\"957\" y=\"346\" />\n            </Array>\n            <mxPoint x=\"932\" y=\"346\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-58\" value=\"14 :&amp;amp;nbsp;avdt_ccb_snd_start_cmd\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"737\" y=\"326\" width=\"180\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-59\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"907\" y=\"387\" width=\"10\" height=\"54\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-60\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"912\" y=\"378\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"912\" y=\"378\" />\n              <mxPoint x=\"942\" y=\"378\" />\n              <mxPoint x=\"942\" y=\"391\" />\n            </Array>\n            <mxPoint x=\"917\" y=\"391\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-61\" value=\"15 :&amp;amp;nbsp;avdt_ccb_hdl_start_rsp\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"743\" y=\"368\" width=\"170\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-62\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"912\" y=\"407\" width=\"10\" height=\"31\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-63\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"917\" y=\"398\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"917\" y=\"398\" />\n              <mxPoint x=\"947\" y=\"398\" />\n              <mxPoint x=\"947\" y=\"411\" />\n            </Array>\n            <mxPoint x=\"922\" y=\"411\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-64\" value=\"16 :&amp;amp;nbsp;avdt_scb_hdl_start_rsp\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"744\" y=\"393\" width=\"170\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-65\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"765\" y=\"436\" width=\"10\" height=\"31\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-66\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"907\" y=\"440\" as=\"sourcePoint\" />\n            <mxPoint x=\"775\" y=\"440\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-67\" value=\"17 :&amp;amp;nbsp;bta_av_stream0_cback&amp;lt;br&amp;gt;AVDT_START_CFM_EVT\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"772\" y=\"435\" width=\"170\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-68\" value=\"\" style=\"html=1;points=[];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;edgeStyle&amp;quot;:&amp;quot;elbowEdgeStyle&amp;quot;,&amp;quot;elbow&amp;quot;:&amp;quot;vertical&amp;quot;,&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"907\" y=\"473\" width=\"10\" height=\"74\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-69\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"770\" y=\"477\" as=\"sourcePoint\" />\n            <mxPoint x=\"907\" y=\"477\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-70\" value=\"18 :&amp;amp;nbsp;bta_sys_sendmsg&amp;lt;br style=&amp;quot;border-color: var(--border-color); font-size: 11px; text-align: left;&amp;quot;&amp;gt;&amp;lt;div style=&amp;quot;text-align: left;&amp;quot;&amp;gt;BTA_AV_STR_START_OK_EVT&amp;lt;/div&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"715\" y=\"472\" width=\"200\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-72\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"913\" y=\"518\" width=\"10\" height=\"26\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-73\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"918\" y=\"509\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"918\" y=\"509\" />\n              <mxPoint x=\"948\" y=\"509\" />\n              <mxPoint x=\"948\" y=\"522\" />\n            </Array>\n            <mxPoint x=\"923\" y=\"522\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-75\" value=\"19 :&amp;amp;nbsp;bta_av_start_ok\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"785\" y=\"505\" width=\"130\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-76\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"615\" y=\"539\" width=\"10\" height=\"111\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-77\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"907\" y=\"543\" as=\"sourcePoint\" />\n            <mxPoint x=\"625\" y=\"543\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-78\" value=\"20 :&amp;amp;nbsp;bte_av_callback&amp;lt;br&amp;gt;BTA_AV_START_EVT\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"628\" y=\"507\" width=\"140\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-79\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"620\" y=\"559\" width=\"10\" height=\"87\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-80\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"625\" y=\"550\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"625\" y=\"550\" />\n              <mxPoint x=\"655\" y=\"550\" />\n              <mxPoint x=\"655\" y=\"563\" />\n            </Array>\n            <mxPoint x=\"630\" y=\"563\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-81\" value=\"21 :&amp;amp;nbsp;btif_sm_dispatch&amp;lt;br&amp;gt;BTA_AV_START_EVT\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"485\" y=\"537\" width=\"140\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-82\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"625\" y=\"585\" width=\"10\" height=\"58\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-83\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"630\" y=\"576\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"630\" y=\"576\" />\n              <mxPoint x=\"660\" y=\"576\" />\n              <mxPoint x=\"660\" y=\"589\" />\n            </Array>\n            <mxPoint x=\"635\" y=\"589\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-84\" value=\"22 : 切换到start状态&amp;lt;br&amp;gt;btif_av_state_started_handler\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"650\" y=\"559\" width=\"180\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-85\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"630\" y=\"604\" width=\"10\" height=\"36\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-86\" value=\"\" style=\"html=1;align=left;spacingLeft=2;endArrow=block;rounded=0;edgeStyle=orthogonalEdgeStyle;curved=0;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0097\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"635\" y=\"595\" as=\"sourcePoint\" />\n            <Array as=\"points\">\n              <mxPoint x=\"635\" y=\"595\" />\n              <mxPoint x=\"665\" y=\"595\" />\n              <mxPoint x=\"665\" y=\"608\" />\n            </Array>\n            <mxPoint x=\"640\" y=\"608\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"v3OjP2-ga7orHbzhjRnd-88\" value=\"23 :&amp;amp;nbsp;btif_a2dp_on_started\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"466\" y=\"587\" width=\"160\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"H6DSlBZDAUEV-tvKv-KM-1\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"480\" y=\"634\" width=\"10\" height=\"31\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"H6DSlBZDAUEV-tvKv-KM-2\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"630\" y=\"638\" as=\"sourcePoint\" />\n            <mxPoint x=\"490\" y=\"638\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"H6DSlBZDAUEV-tvKv-KM-3\" value=\"24 :&amp;amp;nbsp;ack_stream_started\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"480\" y=\"641\" width=\"150\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"H6DSlBZDAUEV-tvKv-KM-4\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"344\" y=\"657\" width=\"10\" height=\"32\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"H6DSlBZDAUEV-tvKv-KM-5\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" parent=\"1\" edge=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"480\" y=\"661\" as=\"sourcePoint\" />\n            <mxPoint x=\"354\" y=\"661\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"H6DSlBZDAUEV-tvKv-KM-6\" value=\"25 :&amp;amp;nbsp;provider_-&amp;amp;gt;streamStarted\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBackgroundColor=none;fontColor=#393C56;\" parent=\"1\" vertex=\"1\">\n          <mxGeometry x=\"304\" y=\"635\" width=\"180\" height=\"30\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"asobWMj1rEDppED49abo-3\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"480\" y=\"678\" width=\"10\" height=\"31\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"asobWMj1rEDppED49abo-4\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"354\" y=\"683\" as=\"sourcePoint\" />\n            <mxPoint x=\"480\" y=\"683\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"asobWMj1rEDppED49abo-5\" value=\"26 : 继续执行out_write&amp;lt;br&amp;gt;OutWritePcmData\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"345\" y=\"679\" width=\"140\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"asobWMj1rEDppED49abo-6\" value=\"\" style=\"html=1;points=[[0,0,0,0,5],[0,1,0,0,-5],[1,0,0,0,5],[1,1,0,0,-5]];perimeter=orthogonalPerimeter;outlineConnect=0;targetShapes=umlLifeline;portConstraint=eastwest;newEdgeStyle={&amp;quot;curved&amp;quot;:0,&amp;quot;rounded&amp;quot;:0};labelBackgroundColor=none;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"615\" y=\"698\" width=\"10\" height=\"31\" as=\"geometry\" />\n        </mxCell>\n        <mxCell id=\"asobWMj1rEDppED49abo-7\" value=\"\" style=\"html=1;verticalAlign=bottom;endArrow=block;elbow=vertical;rounded=0;labelBackgroundColor=none;fontColor=default;strokeColor=#E07A5F;\" edge=\"1\" parent=\"1\">\n          <mxGeometry x=\"0.0093\" relative=\"1\" as=\"geometry\">\n            <mxPoint x=\"490\" y=\"703\" as=\"sourcePoint\" />\n            <mxPoint x=\"615\" y=\"703\" as=\"targetPoint\" />\n            <mxPoint as=\"offset\" />\n          </mxGeometry>\n        </mxCell>\n        <mxCell id=\"asobWMj1rEDppED49abo-8\" value=\"27 : btif_a2dp_source_read_callback&amp;lt;br&amp;gt;从FMQ读取数据，经codec编码后发送\" style=\"text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;\" vertex=\"1\" parent=\"1\">\n          <mxGeometry x=\"613\" y=\"693\" width=\"230\" height=\"40\" as=\"geometry\" />\n        </mxCell>\n      </root>\n    </mxGraphModel>\n  </diagram>\n</mxfile>\n"}'></div><script type=text/javascript src=https://viewer.diagrams.net/js/viewer-static.min.js></script></div><p>bt audio hal在调用BluetoothAudioPortOut::Start后进入一个等待状态，等待条件变量<code>std::condition_variable</code>被唤醒</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>BluetoothAudioSessionControl</span><span class=o>::</span><span class=n>StartStream</span><span class=p>(</span><span class=n>session_type_</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>retval</span> <span class=o>=</span> <span class=n>CondwaitState</span><span class=p>(</span><span class=n>BluetoothStreamState</span><span class=o>::</span><span class=n>STARTING</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>协议栈执行完stream start后通过bt audio hal interface给bt audio hal发送ack消息，最终BluetoothAudioPortOut::ControlResultHandler切换流状态，唤醒条件变量<br>之后out_write继续往下执行，out->bluetooth_output_.WriteData(buffer, bytes)把数据写入HIDL FMQ中。<br>bt协议栈发送了Stream Start后，收到对端发过来的response消息，最终回调到btif_a2dp_on_started，主要逻辑如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>pending_cmd</span> <span class=o>==</span> <span class=n>A2DP_CTRL_CMD_START</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>bluetooth</span><span class=o>::</span><span class=n>audio</span><span class=o>::</span><span class=n>a2dp</span><span class=o>::</span><span class=n>ack_stream_started</span><span class=p>(</span><span class=n>A2DP_CTRL_ACK_SUCCESS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>btif_av_get_peer_sep</span><span class=p>()</span> <span class=o>==</span> <span class=n>AVDT_TSEP_SNK</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Start the media task to encode the audio */</span>
</span></span><span class=line><span class=cl>	 <span class=k>if</span><span class=p>(</span><span class=n>bluetooth</span><span class=o>::</span><span class=n>audio</span><span class=o>::</span><span class=n>a2dp</span><span class=o>::</span><span class=n>get_session_type</span><span class=p>()</span> <span class=o>==</span>
</span></span><span class=line><span class=cl>		  <span class=n>SessionType</span><span class=o>::</span><span class=n>A2DP_SOFTWARE_ENCODING_DATAPATH</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	   <span class=n>APPL_TRACE_IMP</span><span class=p>(</span><span class=s>&#34;%s: start audio as it is SW session&#34;</span><span class=p>,</span> <span class=n>__func__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	   <span class=n>btif_av_reset_reconfig_flag</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	   <span class=n>btif_a2dp_source_start_audio_req</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	 <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>btif_a2dp_source_start_audio_req</code>启动media task读取音频数据并编码发送。</p><h3 id=bluetooth-audio-hal>Bluetooth Audio HAL
<a class=header-anchor href=#bluetooth-audio-hal></a></h3><p>bluetooth audio hal代码位于：<br>hardware/interfaces/bluetooth/audio<br>hardware/interfaces/audio/common/all-versions/default/service/service.cpp注册该hal服务：<br>q代码在adev_open中注册bt audio hal服务<br><strong>service.cpp注册了audio核心api IDevicesFactory， AudioFlinger通过HIDL调用 DevicesFactory::openDevice</strong><br><strong>因此不管是在service.cpp注册还是在adev_open中注册，都是同一个进程。</strong><br><strong>BT audio Hal在android.hardware.audio.service进程中</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>fail</span> <span class=o>=</span> <span class=n>registerPassthroughServiceImplementation</span><span class=o>&lt;</span>
</span></span><span class=line><span class=cl>                  <span class=n>bluetooth</span><span class=o>::</span><span class=n>audio</span><span class=o>::</span><span class=n>V2_0</span><span class=o>::</span><span class=n>IBluetoothAudioProvidersFactory</span><span class=o>&gt;</span><span class=p>()</span> <span class=o>!=</span> <span class=n>OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>ALOGW_IF</span><span class=p>(</span><span class=n>fail</span><span class=p>,</span> <span class=s>&#34;Could not register Bluetooth Audio API 2.0&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>音频设备库位于：<br>system/bt/audio_bluetooth_hw<br>编译结果为：audio.bluetooth.default.so<br>音频库由AudioFlinger初始化时通过解析frameworks/av/services/audiopolicy/config/audio_policy_configuration.xml文件加载</p><p>bt stack作为client对bt audio hal服务的调用流程如下：<br>btif/src/btif_av.cc &mdash;-> src_set_active_sink//call from JNI<br>btif/src/btif_a2dp_source.cc &mdash;-> btif_a2dp_source_start_session<br>BluetoothAudioClientInterface::StartSession &mdash;-> fetch provider & 创建数据队列</p></div><footer class=post-footer><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/bluetooth/bluedroid_osi/ rel=next title=bluedroid_osi><i class="fa fa-chevron-left"></i> bluedroid_osi</a></div><div class="post-nav-prev post-nav-item"></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2024</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>NexT 主题</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.118.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":false,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":false,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":false,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3"}</script><script type=text/javascript src=/js/main.min.8bed02e534b6e1c537aaa55d7fb825ffd51152611df69802eca9b0a5a5aa26a5.js defer></script></body></html>